<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WannaSmile | Favorites</title>
  <link rel="icon" href="system/images/favicons/logoo.png" />

  <!-- ✅ Core UI Styles -->
  <link rel="stylesheet" href="system/css/loading-screen.css" />
  <link rel="stylesheet" href="system/css/main.css" />
  <link rel="stylesheet" href="system/css/themes.css" />

  <meta name="author" content="Bg.uhm by rhap5ody" />
  <meta name="keywords" content="fun, library, github, rhap5ody" />

  <!-- ✅ Only essential JS -->
  <script src="system/js/all.js"></script>
  <script src="system/js/settings.js" defer></script>

  <!-- ✅ Optional UI -->
  <script src="system/js/quotes.js" defer></script>

  <style>
    .update-popup {
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.65); backdrop-filter: blur(6px);
      z-index: 9999; opacity: 0; pointer-events: none;
      transition: opacity 0.5s ease;
    }
    .update-popup.show { opacity: 1; pointer-events: all; }
    .update-popup-content {
      background: var(--background-color,#1e1e1e);
      border-radius: 14px; box-shadow: 0 0 20px rgba(0,0,0,0.6);
      width: 90%; max-width: 480px; text-align: center;
      padding: 20px; color: var(--text-color,#fff);
      animation: popup-bounce 0.6s ease;
    }
    .update-popup-content h2 { margin-top:0; color: var(--accent-color,#fff); }
    .update-popup-content p { font-size:0.95em; margin:10px 0 20px; }
    @keyframes popup-bounce {
      0%{transform:scale(0.9);opacity:0;}
      60%{transform:scale(1.05);opacity:1;}
      100%{transform:scale(1);}
    }
  </style>
</head>

<body>
  <!-- ✅ Preloader -->
  <div class="preloader" id="preloader">
    <div class="loader-gif">
      <img src="system/images/GIF/loading.gif" alt="Loading..." />
    </div>
    <div class="counter" id="counter">0%</div>
    <div class="loading-text">Loading favorites...</div>
  </div>

  <header>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="favorites.html" class="active">Favorites</a>
      <a href="system/pages/discovery.html">Discovery</a>
      <a href="system/pages/settings.html">Settings</a>
      <a href="system/pages/support.html">Support</a>
      <a href="system/pages/info.html">Info</a>
    </nav>
    <div class="header-controls">
      <div class="search-box">
        <input type="text" id="searchInputHeader" placeholder="Search favorites..." />
        <button id="searchBtnHeader">
          <img src="system/icons/search.png" alt="Search" />
        </button>
      </div>
      <a href="system/pages/profile.html">
        <img src="system/icons/profile.png" alt="profile" id="pfp" />
      </a>
      <img src="system/icons/dashboard.png" alt="Dashboard" id="dashboardBtn" />
    </div>
  </header>

  <div id="quoteWrapper"><p id="quoteBox"></p></div>

  <main>
    <div id="container" class="asset-container">Loading favorites...</div>
  </main>

  <button id="toTopBtn">⬆ Top</button>

  <footer>
    <a href="system/pages/sources.html">sources</a>
    <a href="system/pages/contributors.html">contribute</a>
    <a href="system/pages/discord.html">Discord</a>
    <a href="system/pages/bugsNfixes.html">Bugs & fixes</a>
    <a href="system/pages/contact.html">Socials</a>
    <a href="system/pages/version-log.html">version V0.8</a>
  </footer>

  <div id="dashboardMenu" class="dashboard-menu">
    <a href="system/pages/music-player.html">Music Player</a>
    <a href="system/pages/settings-themes.html">Themes</a>
    <a href="system/pages/credits.html">Credits</a>
    <a href="system/pages/alternative.html">Alternative Links</a>
  </div>

  <!-- ✅ FAVORITES PAGE LOGIC + OFFLINE CACHE -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const waitReady = setInterval(() => {
        if (
          window.dom &&
          typeof createAssetCards === "function" &&
          typeof hidePreloader === "function" &&
          window.config?.sheetUrl
        ) {
          clearInterval(waitReady);
          loadFavoriteAssets();
        }
      }, 100);
    });

    async function loadFavoriteAssets() {
      showLoading("Loading your favorites...");
      updateProgress(10);

      const favorites = JSON.parse(localStorage.getItem("favorites") || "[]")
        .map(f => f.toLowerCase());

      if (!favorites.length) {
        dom.container.innerHTML =
          "<p style='text-align:center;margin-top:2em;'>No favorites saved yet ⭐</p>";
        return hidePreloader(true);
      }

      // ✅ Step 1: Try cached data first
      const cachedData = JSON.parse(localStorage.getItem("favoritesCache") || "null");
      if (cachedData && Array.isArray(cachedData)) {
        renderFavorites(cachedData, false); // show immediately
        hidePreloader(true);
      }

      // ✅ Step 2: Refresh in background (don’t block UI)
      try {
        const response = await fetch(window.config.sheetUrl, { cache: "no-store" });
        const allAssets = await response.json();

        const favAssets = allAssets.filter(item =>
          favorites.includes((item.title || "").toLowerCase())
        );

        // Update cache if changed
        const oldCache = JSON.stringify(cachedData);
        const newCache = JSON.stringify(favAssets);
        if (oldCache !== newCache) {
          localStorage.setItem("favoritesCache", newCache);
          renderFavorites(favAssets, true); // re-render silently
        }
      } catch (err) {
        console.warn("Offline or failed to fetch new favorites:", err);
        if (!cachedData) {
          dom.container.innerHTML =
            "<p style='text-align:center;margin-top:2em;'>Offline — no cached favorites available.</p>";
        }
      }
    }

    function renderFavorites(favAssets, refreshed = false) {
      if (!favAssets.length) {
        dom.container.innerHTML =
          "<p style='text-align:center;margin-top:2em;'>No favorites found.</p>";
        return;
      }
      const cards = createAssetCards(favAssets);
      if (Array.isArray(cards)) {
        let done = 0;
        cards.forEach(async ({ promise }) => {
          await promise;
          done++;
          updateProgress(Math.floor((done / cards.length) * 100));
        });
      }
      if (refreshed) console.log("Favorites refreshed from network.");
    }

    // ✅ Override global loader
    window.loadAssets = async function () {
      console.log("Favorites page override: skipping full asset load");
      await loadFavoriteAssets();
    };
  </script>
</body>
</html>
